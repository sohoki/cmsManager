<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aten.com.backoffice.sts.cnt.mapper.ContentFileManagerMapper">
	<select id="selectFilePageListByPagination" resultType="ContentFileInfoVO">
		SELECT TB.* FROM 
        (
			SELECT 
				SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT,
				ROWNUM RNUM, X.* 
			FROM 
			(
				SELECT 
					A.ATCH_FILE_ID, 
					SUBSTRING_INDEX(FILE_STRE_COURS, '/',-3) AS FILE_STRE_COURS,
					A.STRE_FILE_NM, 
					A.FILE_EXTSN, 
					A.REPORT_SEQ, 
					A.FILE_THUMNAIL,
					A.ORIGNL_FILE_NM, 
					CASE 
						WHEN LOWER(A.FILE_EXTSN) IN ('mp4', 'avi', 'mpeg') THEN 'MEDIA'
						WHEN LOWER(A.FILE_EXTSN) IN ('jpg', 'jpeg', 'gif', 'png', 'bmp') THEN 'IMAGE'
						WHEN LOWER(A.FILE_EXTSN) IN ('mp3', 'wav', 'mid') THEN 'MUSIC'
					END AS mediaType ,
					A.PLAY_TIME, 
					A.FILE_WIDTH, 
					A.FILE_HEIGHT, 
					A.USEYN
				FROM LETTNFILEDETAIL A
				WHERE 1=1
				<if test="searchKeyword != ''">
					<choose>
						<when test="searchCondition == 'atchFileId'">
							AND A.STRE_FILE_NM LIKE CONCAT('%',#{searchKeyword},'%')
						</when>							
						<otherwise>
							AND A.ORIGNL_FILE_NM LIKE CONCAT('%',#{searchKeyword},'%') 
						</otherwise>
					</choose>
				</if> 						
				ORDER BY A.ATCH_FILE_ID DESC
		     )X
		WHERE 1=1 
		<if test="conType != '' ">
			AND X.mediaType = #{conType} 
		</if>		
		<if test="notConType != null ">
			AND X.mediaType != #{notConType}
		</if>     	      
		) TB 
		WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}       	
	</select>
         
	<select id="selectFilePageListByPaginationTotCnt_S" resultType="java.lang.Integer">
		SELECT NVL(COUNT(*),0) FROM  
		(
			SELECT 
				CASE 
					WHEN LOWER(FILE_EXTSN) IN ('mp4', 'avi', 'mpeg') THEN 'MEDIA'
					WHEN LOWER(FILE_EXTSN) IN ('jpg', 'jpeg', 'gif', 'png', 'bmp') THEN 'IMAGE'
					WHEN LOWER(FILE_EXTSN) IN ('mp3', 'wav', 'mid') THEN 'MUSIC'
				END AS mediaType
			FROM LETTNFILEDETAIL
			WHERE 1=1   
			<if test="searchKeyword != ''">
				<choose>
					<when test="searchCondition == 'atchFileId'">
						AND STRE_FILE_NM LIKE '%' || #{searchKeyword} || '%'
					</when>							
					<otherwise>
						AND ORIGNL_FILE_NM LIKE '%' || #{searchKeyword}  || '%'
					</otherwise>
				</choose>
			</if>            
		) X
		WHERE 1=1 
		<if test="conType != '' " >
			AND X.mediaType = #{conType} 
		</if>
		<if test="notConType != '' ">
			AND X.mediaType != #{notConType}
		</if>     	      	       
	</select>  
    
    <select id="fileDelInfo" resultType="ContentFileInfo">
		SELECT 
			STRE_FILE_NM, 
			FILE_STRE_COURS  
		FROM LETTNFILEDETAIL
		WHERE REPORT_SEQ IN 
		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
    </select>
    
    <select id="selectFileListTotCnt_S"  resultType="java.lang.Integer">
		SELECT 
			NVL(COUNT(*),0)
		FROM LETTNFILEDETAIL
		WHERE CON_SEQ = #{conSeq}		        
	</select>
   
	<select id="selectFileDetail" resultType="ContentFileInfoVO">
	     SELECT 
	     	ATCH_FILE_ID,
	     	('/upload/' || FN_SUBSTRING_INDEX(FILE_STRE_COURS, '/',-2) ||'/') AS FILE_STRE_COURS,
	     	STRE_FILE_NM,
	     	ORIGNL_FILE_NM,
			FILE_EXTSN,
			FILE_SIZE,
			REPORT_SEQ,
			FILE_THUMNAIL,
			CASE 
				WHEN LOWER(FILE_EXTSN) IN ('mp4', 'avi', 'mpeg') THEN 'MEDIA'
				WHEN LOWER(FILE_EXTSN) IN ('jpg', 'jpeg', 'gif', 'png', 'bmp') THEN 'IMAGE'
				WHEN LOWER(FILE_EXTSN) IN ('url') THEN 'URL'
			END AS mediaType, FILE_WIDTH, FILE_HEIGHT, PLAY_TIME
	     FROM LETTNFILEDETAIL
	     WHERE ATCH_FILE_ID = #{atchFileId}
	</select>
   
	<insert id="insertFileManage" >
		{CALL 
			DECLARE 
				BEGIN 
					INSERT INTO TB_REPORTINFO 
					(
						REPORT_SEQ, REPORT_TITLE, REPORT_DC, REPORT_URL, REPORT_GUBUN, REPORT_UESYN, 
						FRST_REGIST_PNTTM, FRST_REGISTER_ID, LAST_UPDT_PNTTM, LAST_UPDUSR_ID, REPORT_PREVIEW
					)
					VALUES 
					(
						SQ_REPORTSEQ.NEXTVAL, #{orignlFileNm}, #{streFileNm}, #{fileStreCours}, #{reportGubun}, 
						'Y',  SYSDATE, #{userId,jdbcType=VARCHAR},  SYSDATE , #{userId,jdbcType=VARCHAR}, #{fileThumnail ,jdbcType=VARCHAR}
				    );
				           
					INSERT INTO LETTNFILEDETAIL
					(
						ATCH_FILE_ID, FILE_STRE_COURS, STRE_FILE_NM, ORIGNL_FILE_NM, FILE_EXTSN, 
						FILE_SIZE, FILE_THUMNAIL, PLAY_TIME, FRST_REGISTER_ID, FRST_REGIST_PNTTM,
						REPORT_SEQ, FILE_WIDTH, FILE_HEIGHT
					)
					VALUES 
					( 
						#{atchFileId} , #{fileStreCours}, #{streFileNm}, #{orignlFileNm}, #{fileExtsn}, 
						#{fileSize, jdbcType=VARCHAR}, #{fileThumnail ,jdbcType=VARCHAR}, #{playTime,  jdbcType=VARCHAR}, #{userId,jdbcType=VARCHAR}, SYSDATE,
						(SELECT MAX(REPORT_SEQ) FROM TB_REPORTINFO), #{fileWidth,  jdbcType=VARCHAR}, #{fileHeight,  jdbcType=VARCHAR}
				    );
				END 
		}
	</insert>
   
	<update id="updateFileManage">
		UPDATE LETTNFILEDETAIL SET 
          	FILE_STRE_COURS = #{fileStreCours}, 
			STRE_FILE_NM = #{streFileNm},
			ORIGNL_FILE_NM = #{orignlFileNm},
			FILE_EXTSN = #{fileExtsn},
			FILE_SIZE = #{fileSize},
			PLAY_TIME = #{playTime,jdbcType=VARCHAR},
			FILE_WIDTH = #{fileWidth,jdbcType=VARCHAR}, 
			FILE_HEIGHT = #{fileHeight,jdbcType=VARCHAR} 
		WHERE ATCH_FILE_ID = #{atchFileId}
   	</update>
   
   	<update id="updateFileDetailInfo">
   	     UPDATE LETTNFILEDETAIL SET 
   	     	PLAY_TIME = #{playTime,jdbcType=VARCHAR},
			FILE_WIDTH = #{fileWidth,jdbcType=VARCHAR}, 
			FILE_HEIGHT = #{fileHeight,jdbcType=VARCHAR} 
   	     WHERE ATCH_FILE_ID = #{atchFileId}
	</update>
   
	<update id="updateFileManageUseYn">
		UPDATE LETTNFILEDETAIL SET 
			USEYN = #{useYn}
		WHERE ATCH_FILE_ID = #{atchFileId}
	</update>
      
   	<delete id="deleteFileManage">
		DELETE FROM LETTNFILEDETAIL WHERE ATCH_FILE_ID = #{atchFileId}   
   	</delete>
   
	<delete id="deleteFileListManage">
       	DELETE FROM LETTNFILEDETAIL 
       	WHERE REPORT_SEQ IN 
		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
	</delete>
</mapper>