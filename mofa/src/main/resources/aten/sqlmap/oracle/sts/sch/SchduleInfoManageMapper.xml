<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aten.com.backoffice.sts.sch.mapper.SchduleInfoManageMapper">
	<select id="selectSchduleInfoManageListByPagination" resultType="SchduleInfoVO">     	      
		SELECT TB.* 
		FROM
		(
			SELECT SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT,
			ROWNUM RNUM, X.*
			FROM 
			(
				SELECT 
					A.SCH_CODE, A.SCH_TITLE, FN_DETAILCODENM(A.SCH_SENDGUBUN) schSendGubun, A.SCH_FILENM, 
					A.SCH_STARTDAY, A.SCH_ENDDAY, A.SCH_STARTTIME, A.SCH_ENDTIME, A.SCH_USEYN,
					A.LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID, A.SCH_MESSAGE, A.SCH_FONTTYPE
				FROM TB_SCHEDULEINFO A
				WHERE 1=1
				<if test="searchKeyword != ''">
					<choose>
						<when test="searchCondition == 'schTitle'">
							AND A.SCH_TITLE LIKE '%' || #{searchKeyword} || '%'
						</when>
						<otherwise>
							AND A.SCH_MESSAGE LIKE '%' || #{searchKeyword} || '%' 
						</otherwise>
					</choose>
				</if>		        
				ORDER BY a.SCH_CODE  DESC
			) X
		) TB
		WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}   
		ORDER BY TB.SCH_CODE DESC
	</select>
	
	<select id="selectScheduleSendInfo" resultType="SchduleInfoVO">
		SELECT 
			A.SCH_CODE, A.SCH_TITLE, A.SCH_FILENM, A.SCH_MESSAGE, A.SCH_STARTDAY, 
			A.SCH_ENDDAY, A.SCH_STARTTIME, A.SCH_ENDTIME, A.SCH_FONTTYPE
		FROM TB_SCHEDULEINFO A, TB_SENDMESSAGEINFO B, TB_AGENTINFO C
		WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.SCH_STARTDAY AND A.SCH_ENDDAY
		AND TO_CHAR(SYSDATE, 'HH24MI') BETWEEN REPLACE(A.SCH_STARTTIME, ':','') AND REPLACE(A.SCH_ENDTIME, ':','')
		AND A.SCH_CODE = B.SCH_CODE
		AND B.AGENT_CODE = C.AGENT_CODE
		AND A.SCH_USEYN ='Y'
		AND B.MSG_SEND = 'Y' 
		AND B.MSG_RECCHECK ='N'
		AND C.AGENT_CODE = #{agentCode}
	</select>
	
	<select id="selectScheduleSendInfoCnt"  resultType="java.lang.Integer">
		SELECT NVL(COUNT(*),0) 
		FROM TB_SCHEDULEINFO A, TB_SENDMESSAGEINFO B, TB_AGENTINFO C
		WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.SCH_STARTDAY AND A.SCH_ENDDAY
		AND TO_CHAR(SYSDATE, 'HH24MISS') BETWEEN A.SCH_STARTTIME AND A.SCH_ENDTIME
		AND A.SCH_USEYN ='Y' 
		AND A.SCH_CODE = B.SCH_CODE 
		AND B.AGENT_CODE = C.AGENT_CODE
		AND A.SCH_USEYN ='Y' AND B.MSG_SEND = 'Y' 
		AND C.AGENT_CODE= #{AGENTCODE} 
		AND B.MSG_RECCHECK ='N' 
	</select>
	
	<select id="selectSchduleInfoManageDetail" resultType="SchduleInfoVO">
		SELECT 
			A.SCH_CODE, A.SCH_TITLE, A.SCH_SENDGUBUN, A.SCH_FILENM, A.SCH_STARTDAY,
			A.SCH_ENDDAY, A.SCH_STARTTIME, A.SCH_ENDTIME, A.SCH_USEYN, A.SCH_MESSAGE,
			A.FRST_REGIST_PNTTM, A.FRST_REGISTER_ID, A.LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID, A.SCH_FONTTYPE
		FROM TB_SCHEDULEINFO A
		WHERE A.SCH_CODE = #{schCode}
   	</select>
   	
	<select id="selectSchduleInfoManageView" resultType="SchduleInfoVO">
		SELECT 
			A.SCH_CODE, A.SCH_TITLE, fn_DetailCodeNm(a.SCH_SENDGUBUN) AS schSendGubunTxt, A.SCH_SENDGUBUN, A.SCH_FILENM,
			A.SCH_STARTDAY, A.SCH_ENDDAY, A.SCH_STARTTIME, A.SCH_ENDTIME, A.SCH_USEYN,
			A.SCH_MESSAGE, A.FRST_REGIST_PNTTM, A.FRST_REGISTER_ID, A.LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID, 
			A.SCH_FONTTYPE
		FROM TB_SCHEDULEINFO A 
		WHERE 1=1 
		AND A.SCH_CODE = #{schCode}
	</select>
	
	<select id="selectSchduleInfoManageListTotCnt_S" resultType="java.lang.Integer">
        SELECT NVL(COUNT(*),0)      
	    FROM TB_SCHEDULEINFO A 
	    WHERE  1=1
		<if test="searchKeyword != ''">
			<choose>
				<when test="searchCondition == 'schTitle'">
					AND A.SCH_TITLE LIKE '%' || #{searchKeyword} || '%'
				</when>
				<otherwise>
					AND A.SCH_MESSAGE LIKE '%' || #{searchKeyword} || '%' 
				</otherwise>
			</choose>
		</if>			    	     
	</select>

	<insert id="insertSchduleInfoManage">
		INSERT INTO TB_SCHEDULEINFO
		(
			SCH_CODE, SCH_TITLE, SCH_SENDGUBUN, SCH_FILENM, SCH_STARTDAY,
			SCH_ENDDAY, SCH_STARTTIME, SCH_ENDTIME, SCH_USEYN, FRST_REGIST_PNTTM,
			FRST_REGISTER_ID, LAST_UPDT_PNTTM, LAST_UPDUSR_ID, SCH_MESSAGE, SCH_FONTTYPE
		)
		VALUES
		(
			#{schCode}, #{schTitle, jdbcType=VARCHAR}, #{schSendGubun,jdbcType=VARCHAR}, #{schFileNm,jdbcType=VARCHAR}, #{schStartDay,jdbcType=VARCHAR },
			#{schEndDay,jdbcType=VARCHAR }, #{schStartTime,jdbcType=VARCHAR }, #{schEndTime,jdbcType=VARCHAR }, #{schUseYn,jdbcType=VARCHAR }, SYSDATE,
			#{userId,jdbcType=VARCHAR}, SYSDATE, #{userId,jdbcType=VARCHAR}, #{schMessage,jdbcType=VARCHAR}, #{schFonttype,jdbcType=VARCHAR}
		)
	</insert>
	
	<update id="updateSchduleInfoManage">
		UPDATE TB_SCHEDULEINFO SET 
			SCH_TITLE = #{schTitle}, 
			SCH_SENDGUBUN = #{schSendGubun,jdbcType=VARCHAR},
			<if test="schFileNm !=  null ">
				SCH_FILENM = #{schFileNm,jdbcType=VARCHAR}
			</if>
			SCH_STARTDAY = #{schStartDay},
			SCH_ENDDAY = #{schEndDay},
			SCH_STARTTIME = #{schStartTime},
			SCH_ENDTIME = #{schEndTime},
			SCH_MESSAGE = #{schMessage,jdbcType=VARCHAR}, 
			SCH_USEYN = #{schUseYn,jdbcType=VARCHAR},
			LAST_UPDT_PNTTM = SYSDATE,
			LAST_UPDUSR_ID = #{userId,jdbcType=VARCHAR}, 
			SCH_FONTTYPE = #{schFonttype,jdbcType=VARCHAR}
		WHERE SCH_CODE = #{schCode}
	</update>
	
	<delete id="deleteSchduleInfoManage">
		DELETE FROM TB_SCHEDULEINFO
		WHERE SCH_CODE = #{schCode}
	</delete>
</mapper>