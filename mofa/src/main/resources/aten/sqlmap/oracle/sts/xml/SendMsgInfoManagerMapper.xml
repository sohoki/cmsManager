<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="aten.com.backoffice.sts.xml.mapper.SendMsgInfoManagerMapper">
	<select id="selectSendMsgInfoManageListByPagination" resultType="SendMsgInfoVO">
		SELECT TB.*
		FROM 
		(
			SELECT 
				SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT, ROWNUM RNUM, X.*
			FROM 
			(
				SELECT 
					A.MSG_SEQ, A.XML_PROCESS_NAME, C.PROCESS_REMARK, A.SEND_RESULT, A.SEND_REGDATE, 
					B.AGENT_NM, A.AGENT_PLAYTIME, A.AGENT_MAC, B.AGENT_IP, A.ERROR_MESSAGE
				FROM TB_AGENTSENDMESSAGEINFO A, TB_AGENTINFO B, TB_SENDMESSAGETYPR C
				WHERE A.AGENT_CODE = B.AGENT_CODE
				AND A.XML_PROCESS_NAME = C.XML_PROCESS_NAME
				<if test="searchKeyword != ''">
					<choose>
						<when test="searchCondition == 'XML_PROCESS_NAME'">
							AND C.XML_PROCESS_NAME LIKE #{searchKeyword} || '%'
						</when>
						<otherwise>
							AND a.AGENT_CODE LIKE #{searchKeyword} || '%'
						</otherwise>
					</choose>
				</if>
				<if test="agentCode != '' ">
					AND A.AGENT_CODE = #{agentCode}
				</if>
				<if test="msgSeq !=  ''">
					AND A.MSG_SEQ = #{msgSeq}
				</if>
				<if test="xmlProcessName != ''">
					AND A.XML_PROCESS_NAME = #{xmlProcessName}
				</if>
				<if test="schStartDay != ''">
					AND TO_CHAR(SYSDATE, 'yyyyMMdd') between #{schStartDay} AND #{schEndDay}
				</if>
				ORDER BY A.MSG_SEQ DESC
			) X
		) TB
		WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}
		ORDER BY TB.MSG_SEQ DESC
	</select>
	
	<!-- <select id="selectSendMsgInfoManageListTotCnt_S" resultType="java.lang.Integer"> 
		SELECT NVL(COUNT(*),0) FROM TB_AGENTSENDMESSAGEINFO a, TB_AGENTINFO b, TB_SENDMESSAGETYPR 
		c WHERE a.AGENT_CODE = b.AGENT_CODE and a.XML_PROCESS_NAME = c.XML_PROCESS_NAME 
		AND e.AGENT_CODE = a.AGENT_CODE AND d.GROUP_CODE = e.GROUP_CODE <if test="searchKeyword 
		!= ''"> <choose> <when test="searchCondition == 'XML_PROCESS_NAME'"> AND 
		c.XML_PROCESS_NAME LIKE #{searchKeyword} || '%' </when> <otherwise> AND a.AGENT_CODE 
		LIKE #{searchKeyword} || '%' </otherwise> </choose> </if> <if test="agentCode 
		!= '' "> AND a.AGENT_CODE = #{agentCode} </if> <if test="msgSeq != ''"> AND 
		a.MSG_SEQ = #{msgSeq} </if> <if test="xmlProcessName != ''"> AND a.XML_PROCESS_NAME 
		= #{xmlProcessName} </if> <if test="schStartDay != ''"> AND TO_CHAR(SYSDATE, 
		'yyyyMMdd') between #{schStartDay} and #{schEndDay} </if> </select> -->

	<select id="selectAgentOrderCount" resultType="java.lang.Integer">
		SELECT NVL(COUNT(A.MSG_SEQ),0)
		FROM TB_AGENTSENDMESSAGEINFO A, TB_SENDMESSAGETYPR B
		WHERE A.XML_PROCESS_NAME = B.XML_PROCESS_NAME
		AND B.WORK_GUBUN = 'WORKGUBUN_2'
		AND A.SEND_RESULT = 'N'
		AND A.AGENT_CODE = #{agentCode} 
		AND TRIM(A.AGENT_MAC) = #{agentMac}
	</select>

	<select id="selectAgentMessageCount" resultType="java.lang.Integer">
		SELECT NVL(COUNT(*),0)
		FROM TB_DIDSENDMESSAGE A, TB_AGENTINFO B
		WHERE A.SEND_DIDCHECKDATE IS NULL
		AND A.AGENT_CODE = B.AGENT_CODE
		AND A.AGENT_CODE = #{agentCode} 
		AND B.DID_MAC= #{agentMac}
	</select>

	<select id="selectAgentOrderLst" resultType="SendMsgInfoVO">
		SELECT 
			A.MSG_SEQ AS MSGSEQ, A.XML_PROCESS_NAME AS xmlProcessName, A.SEND_REGDATE AS sendRegdate, A.SEND_RESULT AS sendResult
		FROM TB_AGENTSENDMESSAGEINFO A, TB_SENDMESSAGETYPR B
		WHERE A.XML_PROCESS_NAME = B.XML_PROCESS_NAME
		AND B.WORK_GUBUN = 'WORKGUBUN_2'
		AND A.SEND_RESULT = 'N'
		AND A.AGENT_CODE = #{agentCode} 
		AND TRIM(A.AGENT_MAC) = #{agentMac}
		ORDER BY MSG_SEQ ASC
	</select>

	<!-- <select id="selectMaxSeq" resultType="java.lang.Integer"> SELECT MAX(MSG_SEQ) 
		FROM TB_AGENTSENDMESSAGEINFO </select> -->
	<insert id="insertSendMsgInfoManageList" parameterType="list">
		{CALL
			DECLARE
			<foreach item="sendMsgInfo" collection="list" index="index" separator=";" open="BEGIN" close="; END">
				UPDATE TB_AGENTSENDMESSAGEINFO SET 
					SEND_RESULT = 'Y',
					AGENT_PLAYTIME = SYSDATE,
					ERROR_MESSAGE = 'system update'
				WHERE XML_PROCESS_NAME = #{sendMsgInfo.xmlProcessName}
				AND SEND_RESULT = 'N'
				AND AGENT_CODE = #{sendMsgInfo.agentCode};

				INSERT INTO TB_AGENTSENDMESSAGEINFO 
				(
					MSG_SEQ, AGENT_CODE, AGENT_MAC, XML_PROCESS_NAME, SEND_RESULT,
					SEND_REGDATE, FRST_REGIST_PNTTM, FRST_REGISTER_ID
				)
				VALUES 
				(
					SQ_AGENTMSGSEQ.NEXTVAL, #{sendMsgInfo.agentCode}, #{sendMsgInfo.agentMac}, #{sendMsgInfo.xmlProcessName}, #{sendMsgInfo.sendResult},
					SYSDATE, SYSDATE, #{sendMsgInfo.frstRegisterId,jdbcType=VARCHAR} 
				)
				<!-- 여기 부분에 set msgSeq 받을수 있게 정리 -->
			</foreach>
		}
	</insert>
	
	<!-- <insert id="insertSendMsgInfoManage" parameterType="SendMsgInfo" useGeneratedKeys="true" keyColumn="MSG_SEQ" keyProperty="msgSeq"> -->
	
	<insert id="insertSendMsgInfoManage">
		{CALL
			DECLARE
			BEGIN
			<!-- useGeneratedKeys sequence 처리 기능 확인해 보기 -->
			<!-- <selectKey resultType="String" keyProperty="errorMessage" order="BEFORE"> 
					SELECT TO_CHAR(NVL(COUNT(*),0)) 
					FROM TB_AGENTSENDMESSAGEINFO 
					WHERE XML_PROCESS_NAME = #{xmlProcessName} 
					AND SEND_RESULT = 'N' 
					AND AGENT_CODE = #{agentCode}
				</selectKey> 
				<if test="errorMessage != 0"> -->
				UPDATE TB_AGENTSENDMESSAGEINFO SET 
					SEND_RESULT = 'Y',
					AGENT_PLAYTIME = SYSDATE,
					ERROR_MESSAGE = 'system update'
				WHERE XML_PROCESS_NAME = #{xmlProcessName}
				AND SEND_RESULT = 'N'
				AND AGENT_CODE = #{agentCode} ;
				<!-- </if> -->
				INSERT INTO TB_AGENTSENDMESSAGEINFO 
				(
					MSG_SEQ, AGENT_CODE, AGENT_MAC, XML_PROCESS_NAME, SEND_RESULT,
					SEND_REGDATE, FRST_REGIST_PNTTM, FRST_REGISTER_ID
				)
				VALUES 
				(
					TO_CHAR(SQ_AGENTMSGSEQ.NEXTVAL), #{agentCode}, #{agentMac}, #{xmlProcessName} , #{sendResult}, 
					SYSDATE , SYSDATE, #{frstRegisterId,jdbcType=VARCHAR}
				);

				<selectKey resultType="String" keyProperty="msgSeq" order="AFTER">
					SELECT TO_CHAR(MAX(MSG_SEQ))
					FROM TB_AGENTSENDMESSAGEINFO
				</selectKey>
			END
		}
	</insert>
	
	<update id="updateSendMsgInfoManage">
		UPDATE TB_AGENTSENDMESSAGEINFO SET
			SEND_RESULT = #{sendResult}, 
			AGENT_MAC = #{agentMac},
			AGENT_PLAYTIME = SYSDATE,
			ERROR_MESSAGE = #{errorMessage}
		WHERE MSG_SEQ = #{msgSeq}
	</update>
</mapper>   