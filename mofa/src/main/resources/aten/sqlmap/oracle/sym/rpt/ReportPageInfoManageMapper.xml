<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aten.com.backoffice.sts.report.mapper.ReportPageInfoManageMapper">
	<select id="selectReportPageInfoManageListByPagination" resultType="ReportPageInfoVO">
		SELECT TB.*
		FROM 
		(
			SELECT 
				SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT, ROWNUM RNUM, X.*
			FROM 
			(
				SELECT 
					A.REPORT_SEQ, A.REPORT_TITLE, A.REPORT_DC,
					<!-- REPORT_URL -->
					CASE A.REPORT_GUBUN
						WHEN 'reportGubun_3' then REPLACE(A.REPORT_URL, #{replacePath}, '') || A.REPORT_DC
						WHEN 'reportGubun_4' then REPLACE(A.REPORT_URL, #{replacePath}, '') || A.REPORT_PREVIEW
						ELSE A.REPORT_URL
					END REPORT_URL,
					<!-- REPORT_URL_REAL -->
					CASE A.REPORT_GUBUN
						WHEN 'reportGubun_3' THEN REPLACE(A.REPORT_URL, #{replacePath}, '') || A.REPORT_DC
						WHEN 'reportGubun_4' THEN REPLACE(A.REPORT_URL, #{replacePath}, '') || A.REPORT_DC
						ELSE A.REPORT_URL
					END REPORT_URL_REAL,
					A.REPORT_GUBUN, A.REPORT_UESYN reportUseYn, A.FRST_REGIST_PNTTM, A.FRST_REGISTER_ID,
					<!-- REPORT_PREVIEW -->
					CASE A.REPORT_GUBUN
						WHEN 'reportGubun_3' THEN
						(
							SELECT 
								ATCH_FILE_ID|| ',' || NVL(FILE_WIDTH, '') || ',' || NVL(FILE_HEIGHT,'') || ',' || NVL(PLAY_TIME, '')
							FROM LETTNFILEDETAIL B
							WHERE B.STRE_FILE_NM = A.REPORT_DC
						)
						WHEN 'reportGubun_4' THEN
						(
							SELECT 
								ATCH_FILE_ID|| ',' || NVL(FILE_WIDTH, '')|| ',' || NVL(FILE_HEIGHT,'') || ',' || NVL(PLAY_TIME, '')
							FROM LETTNFILEDETAIL B
							WHERE B.STRE_FILE_NM = A.REPORT_DC
						)
						ELSE REPORT_PREVIEW
					END REPORT_PREVIEW
				FROM TB_REPORTINFO A, TB_PARTINFO C, TB_MANAGERINFO B
				WHERE A.FRST_REGISTER_ID = B.ADMIN_ID
				AND B.PART_ID = C.PART_ID
				<if test="searchKeyword != '' ">
					<choose>
						<when test="searchCondition == 'reportDc' ">
							AND A.REPORT_DC LIKE '%' || #{searchKeyword} || '%'
						</when>
						<otherwise>
							AND A.REPORT_TITLE LIKE '%' || #{searchKeyword} || '%'
						</otherwise>
					</choose>
				</if>
				<if test="reportUseYn != ''">
					AND REPORT_UESYN = #{reportUseYn}
				</if>
				<if test="searchReportGubun != null">
					AND REPORT_GUBUN IN
					<foreach collection="searchReportGubun" item="item" index="index" open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
				<if test="adminLevel != 'ROLE_ADMIN'">
					AND C.PART_ID IN 
					(
						SELECT PART_ID 
						FROM TB_PARTINFO 
						WHERE PART_ID = #{partId}
						UNION ALL
						SELECT PART_ID
						FROM TB_PARTINFO
						START WITH PARENT_PART_ID = #{partId}
						CONNECT BY PRIOR PART_ID = PARENT_PART_ID
					)
				</if>
				ORDER BY A.REPORT_SEQ DESC
			)X
		) TB
		WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}
		ORDER BY TB.REPORT_SEQ DESC
	</select>

	<select id="selectReportPageInfoManageDetail" resultType="ReportPageInfoVO">
		SELECT 
			A.REPORT_SEQ, A.REPORT_TITLE, A.REPORT_DC, A.REPORT_URL, A.REPORT_GUBUN,
			A.REPORT_UESYN reportUseYn, A.FRST_REGIST_PNTTM, A.FRST_REGISTER_ID, A.LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID,
			A.REPORT_PREVIEW
		FROM TB_REPORTINFO A
		WHERE A.REPORT_SEQ = #{reportSeq}
	</select>
	
	<select id="selectReportPageInfoManageView" resultType="ReportPageInfoVO">
		SELECT 
			A.REPORT_SEQ, A.REPORT_TITLE, A.REPORT_DC, A.REPORT_URL, FN_DETAILCODENM(A.REPORT_GUBUN) as reportGubun,
			A.REPORT_UESYN reportUseYn, A.FRST_REGIST_PNTTM, A.FRST_REGISTER_ID, A.LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID
		FROM TB_REPORTINFO A
		WHERE REPORT_SEQ = #{reportSeq}
	</select>
	
	<select id="selectReportMax" resultType="java.lang.String">
		SELECT MAX(REPORT_SEQ)
		FROM TB_REPORTINFO A
	</select>
	
	<select id="selectReportPalyTime" resultType="java.lang.Integer">
		SELECT 
			CASE A.REPORT_GUBUN 
				WHEN 'reportGubun_3' THEN
				(
					SELECT NVL(PLAY_TIME, 1)
					FROM LETTNFILEDETAIL B
					WHERE B.REPORT_SEQ = A.REPORT_SEQ
				)
				ELSE '1'
			END AS PLAY_TIME
		FROM TB_REPORTINFO A
		WHERE A.REPORT_SEQ = #{reportSeq}
	</select>
	
	<select id="selectReportPageInfoManageListTotCnt_S"
		resultType="java.lang.Integer">
		SELECT NVL(COUNT(*),0)
		FROM TB_REPORTINFO A
		WHERE 1=1
		<if test="searchKeyword != ''">
			<choose>
				<when test="searchCondition == 'reportTitle'">
					AND A.REPORT_TITLE LIKE '%' || #{searchKeyword} || '%'
				</when>
				<otherwise>
					AND A.REPORT_DC LIKE '%' || #{searchKeyword} || '%'
				</otherwise>
			</choose>
		</if>
		<if test="reportUseYn != ''">
			AND REPORT_UESYN = #{reportUseYn}
		</if>
	</select>

	<insert id="insertReportPageInfoManage">
		{CALL
			DECLARE
			BEGIN
				INSERT INTO TB_REPORTINFO
				( 
					REPORT_SEQ, REPORT_TITLE, REPORT_DC, REPORT_URL,REPORT_GUBUN,
					REPORT_UESYN, FRST_REGIST_PNTTM, FRST_REGISTER_ID, LAST_UPDT_PNTTM, LAST_UPDUSR_ID
				)
				VALUES 
				( 
					SQ_REPORTSEQ.NEXTVAL, #{reportTitle, jdbcType=VARCHAR}, #{reportDc, jdbcType=VARCHAR}, #{reportUrl}, #{reportGubun, jdbcType=VARCHAR}, 
					#{reportUseYn, jdbcType=VARCHAR}, SYSDATE, #{userId, jdbcType=VARCHAR}, SYSDATE , #{userId, jdbcType=VARCHAR}
				);
		
				INSERT INTO LETTNFILEDETAIL
				(
					ATCH_FILE_ID, FILE_STRE_COURS, STRE_FILE_NM, ORIGNL_FILE_NM, FILE_EXTSN, 
					FILE_SIZE, FILE_THUMNAIL, PLAY_TIME, FRST_REGISTER_ID, FRST_REGIST_PNTTM, 
					REPORT_SEQ
				)
				VALUES 
				( 
					#{atchFileId}, #{reportUrl}, #{reportDc, jdbcType=VARCHAR}, #{reportTitle, jdbcType=VARCHAR}, 'url', 
					0, '', '1', #{userId, jdbcType=VARCHAR}, SYSDATE, 
					(
						SELECT MAX(REPORT_SEQ)
						FROM TB_REPORTINFO
					)
				);
			END
		}
	</insert>
	
	<update id="updateReportPageInfoManage">
		UPDATE TB_REPORTINFO SET 
			REPORT_TITLE = #{reportTitle}, 
			REPORT_DC = #{reportDc, jdbcType=VARCHAR}, 
			REPORT_URL = #{reportUrl, jdbcType=VARCHAR}, 
			REPORT_GUBUN = #{reportGubun}, 
			REPORT_UESYN = #{reportUseYn, jdbcType=VARCHAR},
			LAST_UPDT_PNTTM = SYSDATE,
			LAST_UPDUSR_ID = #{userId, jdbcType=VARCHAR}
		WHERE REPORT_SEQ = #{reportSeq}
	</update>
	
	<update id="updateReportPreviewInfoManage">
		UPDATE TB_REPORTINFO SET 
			REPORT_PREVIEW = #{reportPreview}
		WHERE REPORT_SEQ = #{reportSeq}
	</update>
</mapper>