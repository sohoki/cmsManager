<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aten.com.backoffice.mapper.SendMessageManageMapper">
   
     <select id="selectSendMessageAgentList" resultType="SendMessageInfoVO">
         SELECT b.AGENT_CODE, b.AGENT_NM , a.SCH_CODE, b.agent_remark 
		 FROM tb_agentinfo b    
		 LEFT OUTER JOIN  (SELECT a.SCH_CODE, a.AGENT_CODE FROM  tb_sendmessageinfo a
		 WHERE SCH_CODE = #{schCode}) a  on  a.AGENT_CODE = b.AGENT_CODE 
		 WHERE b.agent_useyn ='Y'
		 <if test="adminLevel != 'ROLE_ADMIN'">
            AND b.PART_ID= #{partId}
         </if> 
		 ORDER BY b.agent_remark asc
     </select>
     <select id="selectSendMessageAgentHistoryList" resultType="SendMessageInfoVO">
 	   SELECT SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT,
       TB.* FROM (
	         SELECT b.AGENT_CODE, a.SCH_CODE, a.send_msgSeq,
	                c.SCH_MESSAGE, c.SCH_FONTTYPE, a.msg_send, a.msg_sendRegdate,
	                a.msg_recCheck, a.msg_recUpdate
			 FROM tb_sendmessageinfo a , tb_agentinfo b, tb_scheduleinfo c
			 WHERE b.agent_useyn ='Y' AND a.AGENT_CODE = b.AGENT_CODE 
			       AND c.SCH_CODE = a.SCH_CODE
			       AND a.AGENT_CODE = #{agentCode}
			 order by a.send_msgSeq asc
	   ) TB 
       ORDER BY TB.send_msgSeq  DESC
       limit  #{firstIndex} ,  #{recordCountPerPage}      
     </select>
     <insert id="insertSendMessage">
         INSERT INTO tb_sendmessageinfo (SCH_CODE,AGENT_CODE, MSG_SEND, MSG_SENDREGDATE, MSG_RECCHECK, MSG_RECUPDATE)
         SELECT #{schCode}, b.AGENT_CODE, 'Y', now(), 'N', NULL  
		 FROM  tb_agentinfo b 
		 LEFT OUTER JOIN  (SELECT a.SCH_CODE, a.AGENT_CODE FROM  tb_sendmessageinfo a
		 WHERE SCH_CODE =  #{schCode}) a
		 ON  a.AGENT_CODE = b.AGENT_CODE
         WHERE a.SCH_CODE IS NULL
              <choose>
                <when test="agentCodeLst.size != 0">
                  AND b.AGENT_CODE IN 
                     <foreach collection="agentCodeLst" item="item" index="index" open="(" separator="," close=")">
                         #{item}
                     </foreach>
                </when>
               </choose>          
    </insert>
    <update id="updateSendMessage">
        update tb_sendmessageinfo  set MSG_RECCHECK = 'N' ,  MSG_RECUPDATE =  null
        where SCH_CODE = #{schCode}
    </update>
    <update id="updateSendMessageAgent">
        update tb_sendmessageinfo set MSG_RECCHECK = #{msgRecCheck}, MSG_RECUPDATE = now()
        WHERE SCH_CODE = #{schCode} and AGENT_CODE = #{agentCode}
    </update>
    <delete id="deleteSendMessageAgent">
        DELETE FROM tb_sendmessageinfo
        WHERE SCH_CODE = #{schCode} AND AGENT_CODE
              IN (SELECT AGENT_CODE FROM tb_agentinfo WHERE
              AGENT_CODE NOT IN 
             <foreach collection="agentCodeLst" item="item" index="index" open="(" separator="," close=")">
               #{item}
             </foreach>
             )
    
    </delete>
    <delete id="deleteSendMessage">
        delete from tb_sendmessageinfo 
        where 1=1  
         <if test="sch_code != ''">
            AND SCH_CODE = #{schCode}
         </if>
         <if test="sendMsgSeq != ''">
            AND SEND_MSGSEQ = #{sendMsgSeq}
         </if>
        
    </delete>
</mapper>